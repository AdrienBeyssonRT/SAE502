---
- name: D√©ploiement de l'infrastructure firewall
  hosts: all
  vars:
    playbook_dir: "{{ playbook_dir | default(ansible_env.PWD | default('/tmp')) }}/ansible/playbooks"
    project_root: "{{ playbook_dir | dirname | dirname }}"
    firewall_container: "firewall"
  
  tasks:
    - name: Afficher le d√©but du d√©ploiement
      debug:
        msg:
          - "=========================================="
          - "  D√âPLOIEMENT DE L'INFRASTRUCTURE"
          - "=========================================="
          - "Ce playbook d√©ploie :"
          - "  1. Reconstruction des conteneurs"
          - "  2. D√©marrage de l'infrastructure"
          - "  3. Configuration UFW avec logging"
          - ""

    # ==========================================
    # √âTAPE 1 : D√âTECTION DE DOCKER COMPOSE
    # ==========================================
    - name: D√©terminer le chemin du projet
      set_fact:
        project_root: "{{ playbook_dir | dirname | dirname | default(ansible_env.PWD | default('/tmp')) }}"

    - name: V√©rifier quel format docker-compose est disponible
      command: docker-compose --version
      register: docker_compose_available
      changed_when: false
      failed_when: false

    - name: D√©finir la commande docker-compose √† utiliser
      set_fact:
        docker_compose_cmd: "{{ 'docker-compose' if docker_compose_available.rc == 0 else 'docker compose' }}"
        docker_compose_file: "{{ project_root }}/docker-compose.yml"

    # ==========================================
    # √âTAPE 2 : RECONSTRUCTION DES CONTENEURS
    # ==========================================
    - name: Arr√™ter les conteneurs existants
      command: "{{ docker_compose_cmd }} -f {{ docker_compose_file }} down"
      register: stop_result
      changed_when: stop_result.rc == 0
      failed_when: false

    - name: Reconstruire les conteneurs avec les nouvelles configurations
      command: "{{ docker_compose_cmd }} -f {{ docker_compose_file }} build --no-cache"
      register: build_result

    - name: D√©marrer les conteneurs
      command: "{{ docker_compose_cmd }} -f {{ docker_compose_file }} up -d"
      register: start_result

    - name: Attendre que les conteneurs soient pr√™ts
      pause:
        seconds: 20

    - name: V√©rifier que tous les conteneurs sont en cours d'ex√©cution
      command: docker ps --format "{{ '{{' }}.Names{{ '}}' }}"
      register: running_containers
      changed_when: false

    - name: Afficher les conteneurs en cours d'ex√©cution
      debug:
        msg: "Conteneurs actifs: {{ running_containers.stdout_lines }}"

    # ==========================================
    # √âTAPE 3 : CONFIGURATION UFW
    # ==========================================
    - name: Attendre que le firewall soit compl√®tement d√©marr√©
      pause:
        seconds: 15

    - name: V√©rifier le statut UFW
      command: docker exec {{ firewall_container }} ufw status verbose
      register: ufw_status
      changed_when: false
      failed_when: false
      retries: 5
      delay: 5

    - name: Afficher le statut UFW
      debug:
        msg: "{{ ufw_status.stdout_lines }}"
      when: ufw_status.rc == 0

    - name: Activer le logging UFW au niveau high
      command: docker exec {{ firewall_container }} ufw logging high
      register: ufw_logging
      changed_when: false
      failed_when: false

    # ==========================================
    # √âTAPE 4 : RSYSLOG H√îTE (optionnel, ignor√© si sudo non disponible)
    # ==========================================
    # Les logs UFW sont g√©r√©s DANS le conteneur firewall (rsyslog ‚Üí Splunk).
    # La config rsyslog sur l'h√¥te n'est pas n√©cessaire pour que les logs remontent.
    - name: "(Optionnel) Config rsyslog sur l'h√¥te pour envoi kern.* vers Splunk"
      block:
        - name: S'assurer que rsyslog est install√© sur l'h√¥te
          ansible.builtin.apt:
            name: rsyslog
            state: present
          become: true

        - name: Copier la config rsyslog pour envoi kern.* vers Splunk
          ansible.builtin.copy:
            src: "{{ project_root }}/ansible/files/99-splunk-ufw.conf"
            dest: /etc/rsyslog.d/99-splunk-ufw.conf
            mode: "0644"
          become: true

        - name: Red√©marrer rsyslog sur l'h√¥te
          ansible.builtin.service:
            name: rsyslog
            state: restarted
          become: true
      rescue:
        - name: Ignorer l'√©chec rsyslog h√¥te (les logs viennent du conteneur firewall)
          ansible.builtin.debug:
            msg: "Config rsyslog sur l'h√¥te ignor√©e (sudo requis). Les logs UFW viennent du conteneur firewall ‚Üí Splunk."

    # ==========================================
    # R√âSUM√â FINAL
    # ==========================================
    - name: R√©sum√© final du d√©ploiement
      debug:
        msg:
          - ""
          - "=========================================="
          - "  ‚úÖ D√âPLOIEMENT TERMIN√â"
          - "=========================================="
          - "Conteneurs actifs: {{ running_containers.stdout_lines | length }}"
          - ""
          - "üåê Interface Splunk disponible sur: http://localhost:8000"
          - "  Identifiants: admin / splunk1RT3"
          - ""
          - "üí° Pour tester et g√©n√©rer des logs:"
          - "  docker exec client /usr/local/bin/test-rules-ufw.sh"
          - ""
          - "üîç Pour voir les logs dans Splunk:"
          - "  1. Connectez-vous √† http://localhost:8000"
          - "  2. Recherche: index=main sourcetype=syslog UFW"
          - ""
