---
- name: DÃ©ploiement complet et test automatisÃ© du systÃ¨me de logs UFW
  hosts: all
  vars:
    playbook_dir: "{{ playbook_dir | default(ansible_env.PWD | default('/tmp')) }}/ansible/playbooks"
    project_root: "{{ playbook_dir | dirname | dirname }}"
    firewall_host: "firewall"
    client_container: "client"
    firewall_container: "firewall"
    logcollector_container: "logcollector"
    splunk_container: "splunk"
  
  tasks:
    - name: Afficher le dÃ©but du dÃ©ploiement
      debug:
        msg:
          - "=========================================="
          - "  DÃ‰PLOIEMENT COMPLET ET TEST AUTOMATISÃ‰"
          - "=========================================="
          - "Ce playbook automatise :"
          - "  1. Reconstruction des conteneurs"
          - "  2. DÃ©marrage de l'infrastructure"
          - "  3. Configuration UFW avec logging"
          - "  4. GÃ©nÃ©ration de trafic pour crÃ©er des logs"
          - "  5. VÃ©rification complÃ¨te de la chaÃ®ne de logs"
          - "  6. VÃ©rification de la catÃ©gorisation (BLOCK/ALLOW)"
          - ""

    # ==========================================
    # Ã‰TAPE 1 : DÃ‰TECTION DE DOCKER COMPOSE
    # ==========================================
    - name: DÃ©terminer le chemin du projet
      set_fact:
        project_root: "{{ playbook_dir | dirname | dirname | default(ansible_env.PWD | default('/tmp')) }}"

    - name: VÃ©rifier quel format docker-compose est disponible
      command: docker-compose --version
      register: docker_compose_available
      changed_when: false
      failed_when: false

    - name: DÃ©finir la commande docker-compose Ã  utiliser
      set_fact:
        docker_compose_cmd: "{{ 'docker-compose' if docker_compose_available.rc == 0 else 'docker compose' }}"
        docker_compose_file: "{{ project_root }}/docker-compose.yml"

    # ==========================================
    # Ã‰TAPE 2 : RECONSTRUCTION DES CONTENEURS
    # ==========================================
    - name: ArrÃªter les conteneurs existants
      command: "{{ docker_compose_cmd }} -f {{ docker_compose_file }} down"
      register: stop_result
      changed_when: stop_result.rc == 0
      failed_when: false

    - name: Reconstruire les conteneurs avec les nouvelles configurations
      command: "{{ docker_compose_cmd }} -f {{ docker_compose_file }} build --no-cache"
      register: build_result

    - name: DÃ©marrer les conteneurs
      command: "{{ docker_compose_cmd }} -f {{ docker_compose_file }} up -d"
      register: start_result

    - name: Attendre que les conteneurs soient prÃªts
      pause:
        seconds: 15

    - name: VÃ©rifier que tous les conteneurs sont en cours d'exÃ©cution
      command: docker ps --format "{{ '{{' }}.Names{{ '}}' }}"
      register: running_containers
      changed_when: false

    - name: Afficher les conteneurs en cours d'exÃ©cution
      debug:
        msg: "Conteneurs actifs: {{ running_containers.stdout_lines }}"

    # ==========================================
    # Ã‰TAPE 2 : CONFIGURATION UFW
    # ==========================================
    - name: Attendre que le firewall soit complÃ¨tement dÃ©marrÃ©
      pause:
        seconds: 10

    - name: Attendre que UFW soit configurÃ© (vÃ©rification avec retry)
      command: docker exec {{ firewall_container }} ufw status | head -1
      register: ufw_check
      changed_when: false
      failed_when: false
      retries: 10
      delay: 3
      until: ufw_check.rc == 0

    - name: VÃ©rifier le statut UFW
      command: docker exec {{ firewall_container }} ufw status verbose
      register: ufw_status
      changed_when: false
      failed_when: false

    - name: Afficher le statut UFW actuel
      debug:
        var: ufw_status.stdout_lines

    - name: VÃ©rifier que UFW est actif
      fail:
        msg:
          - "âŒ ERREUR: UFW n'est pas actif dans le conteneur firewall"
          - "VÃ©rifiez les logs: docker logs firewall"
          - "Statut actuel: {{ ufw_status.stdout }}"
      when: "'Status: active' not in ufw_status.stdout"

    - name: Activer le logging UFW au niveau high si nÃ©cessaire
      command: docker exec {{ firewall_container }} ufw logging high
      register: ufw_logging
      changed_when: "'Logging: on (high)' not in ufw_status.stdout"
      failed_when: false

    - name: VÃ©rifier que le logging est activÃ©
      command: docker exec {{ firewall_container }} ufw status verbose | grep -i logging
      register: logging_check
      changed_when: false
      failed_when: false

    - name: Afficher le statut du logging
      debug:
        msg: "{{ logging_check.stdout if logging_check.rc == 0 else 'Logging non dÃ©tectÃ©' }}"

    - name: Nettoyer les anciens logs pour un test propre
      command: docker exec {{ firewall_container }} sh -c "echo '' > /var/log/kern.log"
      changed_when: false
      failed_when: false

    # ==========================================
    # Ã‰TAPE 3 : VÃ‰RIFICATION DES SERVICES
    # ==========================================
    - name: VÃ©rifier que rsyslog fonctionne dans le firewall
      command: docker exec {{ firewall_container }} ps aux | grep rsyslog | grep -v grep
      register: rsyslog_firewall
      changed_when: false
      failed_when: false

    - name: Afficher le statut rsyslog dans le firewall
      debug:
        msg: "{{ 'rsyslog fonctionne' if rsyslog_firewall.rc == 0 else 'rsyslog ne fonctionne pas' }}"

    - name: VÃ©rifier que rsyslog fonctionne dans le logcollector
      command: docker exec {{ logcollector_container }} ps aux | grep rsyslog | grep -v grep
      register: rsyslog_logcollector
      changed_when: false
      failed_when: false

    - name: Afficher le statut rsyslog dans le logcollector
      debug:
        msg: "{{ 'rsyslog fonctionne' if rsyslog_logcollector.rc == 0 else 'rsyslog ne fonctionne pas' }}"

    - name: VÃ©rifier la connexion rÃ©seau entre firewall et logcollector
      command: docker exec {{ firewall_container }} ping -c 2 {{ logcollector_container }}
      register: network_check
      changed_when: false
      failed_when: false

    - name: Afficher le rÃ©sultat du test rÃ©seau
      debug:
        msg: "{{ 'Connexion rÃ©seau OK' if network_check.rc == 0 else 'ProblÃ¨me de connexion rÃ©seau' }}"

    # ==========================================
    # Ã‰TAPE 4 : GÃ‰NÃ‰RATION DE TRAFIC
    # ==========================================
    - name: ExÃ©cuter les tests UFW pour gÃ©nÃ©rer des logs
      command: docker exec {{ client_container }} /usr/local/bin/test-rules-ufw.sh
      register: traffic_result
      changed_when: false
      failed_when: false

    - name: Afficher le rÃ©sultat de la gÃ©nÃ©ration de trafic
      debug:
        msg: "{{ traffic_result.stdout_lines }}"

    # ==========================================
    # Ã‰TAPE 5 : VÃ‰RIFICATION DES LOGS
    # ==========================================
    - name: Attendre que les logs soient Ã©crits
      pause:
        seconds: 5

    - name: VÃ©rifier les logs UFW dans le firewall
      command: docker exec {{ firewall_container }} tail -100 /var/log/kern.log | grep -i ufw
      register: ufw_logs
      changed_when: false
      failed_when: false

    - name: Compter les logs UFW dans le firewall
      set_fact:
        firewall_log_count: "{{ ufw_logs.stdout_lines | length }}"

    - name: Afficher le nombre de logs UFW dans le firewall
      debug:
        msg: "{{ firewall_log_count }} logs UFW trouvÃ©s dans le firewall"

    - name: Afficher des exemples de logs UFW du firewall
      debug:
        msg: "{{ ufw_logs.stdout_lines[:5] }}"
      when: ufw_logs.stdout_lines | length > 0

    - name: VÃ©rifier que des logs UFW ont Ã©tÃ© gÃ©nÃ©rÃ©s
      fail:
        msg:
          - "âŒ ERREUR: Aucun log UFW trouvÃ© dans le firewall"
          - "VÃ©rifiez que:"
          - "  1. UFW est actif: docker exec {{ firewall_container }} ufw status"
          - "  2. Le logging est activÃ©: docker exec {{ firewall_container }} ufw status verbose | grep Logging"
          - "  3. Les rÃ¨gles UFW sont correctes"
      when: firewall_log_count | int == 0

    - name: Attendre que les logs soient envoyÃ©s au collecteur
      pause:
        seconds: 5

    - name: VÃ©rifier les logs dans le collecteur
      shell: docker exec {{ logcollector_container }} sh -c "tail -100 /var/log/firewall/*.log 2>/dev/null | grep -i ufw" || echo ""
      register: collector_logs
      changed_when: false
      failed_when: false

    - name: Compter les logs dans le collecteur
      set_fact:
        collector_log_count: "{{ collector_logs.stdout_lines | length }}"

    - name: Afficher le nombre de logs dans le collecteur
      debug:
        msg: "{{ collector_log_count }} logs UFW trouvÃ©s dans le collecteur"

    - name: Afficher des exemples de logs du collecteur
      debug:
        msg: "{{ collector_logs.stdout_lines[:5] }}"
      when: collector_logs.stdout_lines | length > 0

    - name: VÃ©rifier que les logs sont bien reÃ§us par le collecteur
      debug:
        msg:
          - "{{ 'âœ… Logs reÃ§us par le collecteur' if collector_log_count | int > 0 else 'âš ï¸  Aucun log reÃ§u par le collecteur' }}"
          - "VÃ©rifiez la chaÃ®ne: firewall -> rsyslog -> logcollector"
          - "Commandes de diagnostic:"
          - "  docker exec {{ firewall_container }} tail -20 /var/log/kern.log | grep UFW"
          - "  docker exec {{ logcollector_container }} tail -20 /var/log/firewall/*.log | grep UFW"

    # ==========================================
    # Ã‰TAPE 6 : VÃ‰RIFICATION DE SPLUNK
    # ==========================================
    - name: Attendre que Splunk soit prÃªt
      pause:
        seconds: 60
      vars:
        splunk_wait_time: 60

    - name: VÃ©rifier que Splunk est en cours d'exÃ©cution
      command: docker ps --filter "name={{ splunk_container }}" --format "{{ '{{' }}.Status{{ '}}' }}"
      register: splunk_status
      changed_when: false
      retries: 10
      delay: 5

    - name: Afficher le statut de Splunk
      debug:
        msg: "Statut Splunk: {{ splunk_status.stdout }}"

    - name: VÃ©rifier que Splunk Ã©coute sur le port 8000
      wait_for:
        host: localhost
        port: 8000
        timeout: 60
      changed_when: false

    - name: Attendre que les logs soient indexÃ©s dans Splunk
      pause:
        seconds: 10
      vars:
        msg: "Attente de l'indexation des logs dans Splunk..."

    - name: VÃ©rifier les logs UFW dans Splunk via recherche
      shell: |
        docker exec {{ splunk_container }} /opt/splunk/bin/splunk search 'index=main sourcetype=syslog "UFW" | head 20' -auth admin:splunk1RT3 2>/dev/null || echo "Aucun log trouvÃ©"
      register: splunk_ufw_logs
      changed_when: false
      failed_when: false
      retries: 5
      delay: 10

    - name: Compter les logs UFW dans Splunk
      shell: |
        docker exec {{ splunk_container }} /opt/splunk/bin/splunk search 'index=main sourcetype=syslog "UFW" | stats count' -auth admin:splunk1RT3 -output csv 2>/dev/null | tail -n 1 || echo "0"
      register: splunk_log_count_raw
      changed_when: false
      failed_when: false
      retries: 3
      delay: 5

    - name: Extraire le nombre de logs
      set_fact:
        splunk_log_count: "{{ splunk_log_count_raw.stdout | regex_replace('^[^0-9]*([0-9]+).*$', '\\1') | default('0') | int }}"

    - name: Afficher le nombre de logs dans Splunk
      debug:
        msg: "{{ splunk_log_count }} logs UFW trouvÃ©s dans Splunk"

    - name: Afficher des exemples de logs Splunk
      debug:
        msg: "{{ splunk_ufw_logs.stdout_lines[:10] }}"
      when: splunk_ufw_logs.stdout_lines | length > 0

    - name: Message si aucun log dans Splunk
      debug:
        msg:
          - "âš ï¸  Aucun log UFW trouvÃ© dans Splunk pour le moment"
          - "Les logs peuvent prendre quelques minutes Ã  Ãªtre indexÃ©s"
          - "VÃ©rifiez dans l'interface Splunk: http://localhost:8000"
          - "Recherche Ã  effectuer: index=main sourcetype=syslog UFW"
          - ""
          - "VÃ©rifiez la chaÃ®ne complÃ¨te:"
          - "  1. Logs dans firewall: docker exec {{ firewall_container }} tail -20 /var/log/kern.log | grep UFW"
          - "  2. Logs dans logcollector: docker exec {{ logcollector_container }} tail -20 /var/log/firewall/*.log | grep UFW"
          - "  3. Splunk reÃ§oit les logs: docker logs {{ splunk_container }} | grep -i udp"
      when: splunk_log_count | int == 0

    - name: Rechercher les logs BLOCK dans Splunk
      shell: |
        docker exec {{ splunk_container }} /opt/splunk/bin/splunk search 'index=main sourcetype=syslog "UFW BLOCK" | stats count' -auth admin:splunk1RT3 -output csv 2>/dev/null | tail -n 1 || echo "0"
      register: splunk_block_count_raw
      changed_when: false
      failed_when: false

    - name: Extraire le nombre de logs BLOCK
      set_fact:
        block_count: "{{ splunk_block_count_raw.stdout | regex_replace('^[^0-9]*([0-9]+).*$', '\\1') | default('0') | int }}"

    - name: Rechercher les logs ALLOW dans Splunk
      shell: |
        docker exec {{ splunk_container }} /opt/splunk/bin/splunk search 'index=main sourcetype=syslog "UFW ALLOW" | stats count' -auth admin:splunk1RT3 -output csv 2>/dev/null | tail -n 1 || echo "0"
      register: splunk_allow_count_raw
      changed_when: false
      failed_when: false

    - name: Extraire le nombre de logs ALLOW
      set_fact:
        allow_count: "{{ splunk_allow_count_raw.stdout | regex_replace('^[^0-9]*([0-9]+).*$', '\\1') | default('0') | int }}"

    - name: Afficher la rÃ©partition par catÃ©gorie
      debug:
        msg:
          - "RÃ©partition des logs par catÃ©gorie dans Splunk:"
          - "  BLOCK (bloquÃ©s): {{ block_count }}"
          - "  ALLOW (autorisÃ©s): {{ allow_count }}"
          - "  Total UFW: {{ splunk_log_count }}"

    - name: VÃ©rifier qu'il y a des logs BLOCK
      debug:
        msg: "âœ… Des logs BLOCK ont Ã©tÃ© dÃ©tectÃ©s dans Splunk (ports bloquÃ©s: 445, 3389, 139, 80)"
      when: block_count | int > 0

    - name: VÃ©rifier qu'il y a des logs ALLOW
      debug:
        msg: "âœ… Des logs ALLOW ont Ã©tÃ© dÃ©tectÃ©s dans Splunk (port autorisÃ©: 22 depuis rÃ©seau interne)"
      when: allow_count | int > 0

    # ==========================================
    # RÃ‰SUMÃ‰ FINAL
    # ==========================================
    - name: RÃ©sumÃ© final du dÃ©ploiement et des tests
      debug:
        msg:
          - ""
          - "=========================================="
          - "  RÃ‰SUMÃ‰ FINAL"
          - "=========================================="
          - "âœ… Conteneurs: Tous dÃ©marrÃ©s"
          - "{{ 'âœ…' if (firewall_log_count | int > 0) else 'âŒ' }} Logs UFW dans le firewall: {{ firewall_log_count }} logs"
          - "{{ 'âœ…' if (collector_log_count | int > 0) else 'âš ï¸ ' }} Logs dans le collecteur: {{ collector_log_count }} logs"
          - "{{ 'âœ…' if (splunk_log_count | int > 0) else 'âš ï¸ ' }} Logs indexÃ©s dans Splunk: {{ splunk_log_count }} logs"
          - ""
          - "ðŸ“Š CatÃ©gorisation dans Splunk:"
          - "  BLOCK: {{ block_count }} logs"
          - "  ALLOW: {{ allow_count }} logs"
          - ""
          - "ðŸŒ Interface Splunk disponible sur: http://localhost:8000"
          - "  Identifiants: admin / splunk1RT3"
          - ""
          - "ðŸ“‹ Pour voir les logs UFW dans Splunk:"
          - "  1. Connectez-vous Ã  http://localhost:8000"
          - "  2. Dans la barre de recherche, tapez: index=main sourcetype=syslog UFW"
          - "  3. Ou utilisez le dashboard: Recherche > Dashboards > UFW Firewall Dashboard"
          - ""
          - "ðŸ” Pour voir les logs en temps rÃ©el:"
          - "  docker exec {{ firewall_container }} tail -f /var/log/kern.log | grep UFW"
          - "  docker exec {{ logcollector_container }} tail -f /var/log/firewall/*.log | grep UFW"
          - ""
          - "ðŸ’¡ Pour gÃ©nÃ©rer plus de logs, exÃ©cutez:"
          - "  docker exec {{ client_container }} /usr/local/bin/test-rules-ufw.sh"
          - ""

    - name: VÃ©rification finale - Tous les tests sont passÃ©s
      debug:
        msg:
          - "âœ… DÃ‰PLOIEMENT ET TESTS RÃ‰USSIS!"
          - "Le systÃ¨me est opÃ©rationnel et les logs sont correctement catÃ©gorisÃ©s."
      when: 
        - firewall_log_count | int > 0
        - splunk_log_count | int > 0

