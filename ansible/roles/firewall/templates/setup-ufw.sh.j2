#!/bin/bash
# Script de configuration UFW avec les règles spécifiées
# Généré automatiquement par Ansible

set -e

# Variables
INTERNAL_NETWORK="{{ internal_network | default('172.20.0.0/16') }}"
LOGGING_LEVEL="{{ logging_level | default('high') }}"

echo "Configuration UFW..."

# Réinitialiser UFW
ufw --force reset

# Règles par défaut
echo "Application des règles par défaut..."
ufw default deny incoming
ufw default allow outgoing
ufw default deny routed

# Configuration du logging
echo "Configuration du logging niveau $LOGGING_LEVEL..."
ufw logging $LOGGING_LEVEL

# Services internes autorisés
echo "Configuration des services internes..."
# SSH interne depuis le réseau interne
ufw allow from $INTERNAL_NETWORK to any port 22 proto tcp comment 'SSH interne'
# Envoi des logs vers le collecteur
ufw allow out 514/udp comment 'Envoi logs vers logcollector'

# Trafic utile autorisé
echo "Configuration du trafic sortant autorisé..."
# DNS sortant
ufw allow out 53/udp comment 'DNS sortant'
ufw allow out 53/tcp comment 'DNS sortant TCP'
# Web sortant
ufw allow out 80/tcp comment 'HTTP sortant'
ufw allow out 443/tcp comment 'HTTPS sortant'

# Blocage des services sensibles
echo "Blocage des services sensibles..."
# SMB/NetBIOS
ufw deny 137/udp comment 'Blocage NetBIOS Name Service'
ufw deny 138/udp comment 'Blocage NetBIOS Datagram Service'
ufw deny 139/tcp comment 'Blocage NetBIOS Session Service'
ufw deny 445/tcp comment 'Blocage SMB'
# RDP
ufw deny 3389/tcp comment 'Blocage RDP'

# Sécurité supplémentaire
echo "Configuration de la sécurité supplémentaire..."
# Limitation SSH pour réduire brute-force
ufw limit 22/tcp comment 'Limitation SSH anti brute-force'

# Activation de UFW
echo "Activation de UFW..."
ufw --force enable

# Affichage du statut
echo "Statut UFW:"
ufw status verbose

echo "Configuration UFW terminée avec succès!"





