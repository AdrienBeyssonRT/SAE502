services:
  firewall:
    build:
      context: ./containers/firewall
      dockerfile: Dockerfile
    container_name: firewall
    hostname: firewall
    networks:
      - main_network
    cap_add:
      - NET_ADMIN
      - NET_RAW
    privileged: true
    security_opt:
      - apparmor=unconfined
    environment:
      - INTERNAL_NETWORK=10.20.0.0/16
      - LOGGING_LEVEL=high
    volumes:
      - /lib/modules:/lib/modules:ro
    # Accès au buffer noyau pour que rsyslog (imklog) reçoive les logs UFW/netfilter
    devices:
      - /dev/kmsg:/dev/kmsg
    restart: unless-stopped

  # Splunk : réception directe des logs UFW depuis le firewall (UDP 514)
  splunk:
    build:
      context: ./containers/splunk
      dockerfile: Dockerfile
    container_name: splunk
    hostname: splunk
    environment:
      - SPLUNK_START_ARGS=--accept-license
      - SPLUNK_GENERAL_TERMS=--accept-sgt-current-at-splunk-com
      - SPLUNK_PASSWORD=splunk1RT3
      - SPLUNK_HOME=/opt/splunk
      - SPLUNK_OPTIMISTIC_ABOUT_FILE_LOCKING=true
    ports:
      - "8000:8000"
      - "9997:9997"
      - "514:514/udp"
    networks:
      - main_network
    volumes:
      - splunk_data:/opt/splunk/var
    restart: unless-stopped
    healthcheck:
      disable: true

  client:
    build:
      context: ./containers/client
      dockerfile: Dockerfile
    container_name: client
    hostname: client
    networks:
      - main_network
    tty: true
    stdin_open: true
    restart: unless-stopped

  attacker:
    build:
      context: ./containers/client
      dockerfile: Dockerfile
    container_name: attacker
    hostname: attacker
    networks:
      - main_network
    tty: true
    stdin_open: true
    restart: unless-stopped

networks:
  main_network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.20.0.0/16

volumes:
  splunk_data:
    driver: local
